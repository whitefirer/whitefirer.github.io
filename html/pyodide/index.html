<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Pyodide in xterm.js</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.0/full/pyodide.js"></script>
    <style>
        #terminal {
            display: flex;
        }
    </style>
</head>

<body>
    <div id="terminal"></div>
    <script>
        const ENTER = '\r';
        const DEL = '\u007F';
        var term = new Terminal();
        term.open(document.getElementById('terminal'));
        var pyodide = null;
        pythonCodeX = 0;
        pythonCodeY = 0;

        var stdout_codes = [];
        function rawstdout(code) {
            stdout_codes.push(code);
        }

        async function startPyodide() {
            term.write('Starting Python...');
            pyodide = await loadPyodide();
            await pyodide.loadPackage("pygments")

            pyodide.runPythonAsync(`
                    import sys
                    from pygments import highlight
                    from pygments.lexers import PythonLexer
                    from pygments.formatters import TerminalTrueColorFormatter
                    sys.version
                `).then(output => {
                term.write('\rPython ' + output + '\r\n');
                term.prompt();
            });

            pyodide.setStdout({ raw: rawstdout, isatty: true });
        }

        term.prompt = () => {
            term.write('\r\x1b[01;32m>>> ');
        };
        var pythonCode = '';
        var blockFlag = "";
        var blockMap = {
            ":": "\r",
            "\\": "\r",
            "{": "}",
            "[": "]",
            "(": ")",
        }

        term.onData(e => {
            const printable = !e.altKey && !e.ctrlKey && !e.metaKey;
            switch (e) {
                case ENTER:
                    if (pythonCode.length > 0) {
                        if (((pythonCode[pythonCode.length - 1] in blockMap)) && (blockFlag == "")) {
                            blockFlag = pythonCode[pythonCode.length - 1];
                            pythonCode += e;
                            term.writeln("\r");
                            term.write('... ');
                            break;
                        }
                        if (blockFlag != "") {
                            if (pythonCode[pythonCode.length - 1] == blockMap[blockFlag]) {
                                blockFlag = false;
                            } else {
                                pythonCode += e;
                                term.writeln("\r");
                                term.write('... ');
                                break;
                            }
                        }
                        term.writeln('\x1b[0m');

                        stdout_codes = []
                        pyodide.runPythonAsync(pythonCode).then(output => {
                            let result = new TextDecoder().decode(new Uint8Array(stdout_codes));
                            if (result.length > 0) {
                                term.write(result.replaceAll("\n", "\r\n"));
                            } else if (output != undefined) {
                                term.write(output + '\n');
                            }
                            term.prompt();
                        }).catch(err => {
                            // term.write('\x1b[01;31m' + err.message.replaceAll('\n', '\r\n') + '\x1b[0m');
                            pythonCode = ""
                            pyodide.runPythonAsync(`
                                _PY_code = """
                                ${err.message.replaceAll('\n', '\r')}
                                """
                                _PY_highlighted_code = highlight(_PY_code, PythonLexer(), TerminalTrueColorFormatter(style='one-dark'));
                                _PY_highlighted_code[:-1]
                            `).then(output => {
                                term.write(output.replaceAll('\n', '\r\n') + '\n')
                                term.prompt();
                            })
                        });

                    } else {
                        term.writeln('\x1b[0m');
                        term.prompt();
                    }
                    pythonCode = '';
                    break;
                case DEL:
                    if (term._core.buffer.x > 4) {
                        term.write('\b \b');
                        if (pythonCode.length > 0) {
                            pythonCode = pythonCode.substr(0, pythonCode.length - 1);
                        }
                    }
                    break;
                default:
                    if (printable) {
                        if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7E) || e >= '\u00a0') {
                            if (pythonCode.length == 0) {
                                pythonCodeX = term.buffer._normal.cursorX + 1;
                                pythonCodeY = term.buffer._normal.cursorY + term.buffer._normal.baseY + 1;
                            }
                            pythonCode += e;
                            
                            // term.write(e);
                            term.write(`\x1b[?25l\x1b[${pythonCodeY - term.buffer._normal.baseY};${pythonCodeX}H`)
                            pyodide.runPythonAsync(`
                                _PY_code = """
                                ${pythonCode.replaceAll("\\", "\\\\")}
                                """
                                _PY_highlighted_code = highlight(_PY_code, PythonLexer(), TerminalTrueColorFormatter(style='native'));
                                _PY_highlighted_code[:-1]
                            `).then(output => {
                                term.write(output.replaceAll('\n', '\r\n... '))
                            })
                            term.write('\x1b[?25h'); // Show cursor
                        }
                    }
            }
        });

        startPyodide();
    </script>
</body>

</html>